# Bundle the app's client and server
name: cicd

on:
  push:
    branches: ["**"]
    tags: ["**"]

jobs:
  versioning:
    uses: gg-math/actions/.github/workflows/versioning.yml@master

  server-testing:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    steps:
    - uses: actions/checkout@v4
    - name: server lint
      run: |
        files=$(gofmt -l .)
        echo "$files"
        test -z "$files"
        # Fix with `gofmt -w .`
  
    - name: server unit tests
      run: |
        echo "## ðŸ§ª Unit testing" >> $GITHUB_STEP_SUMMARY
        go test ./business -cover | tee /tmp/ut-results
        echo "Coverage: $(grep -oP "[\d\.]+%" /tmp/ut-results)" >> $GITHUB_STEP_SUMMARY
  
  client-testing:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: client

    steps:
    - uses: actions/checkout@v4
    - uses: oven-sh/setup-bun@v2
    - run: bun install

    # Unpatched vulnerabilities we can ignore temporarly and open an issue to track the fix.
    # Exemple of entry: --ignore CVE-2025-29927 # https://github.com/darwie-devs/webapp/issues/46
    - name: client audit
      run: |
        bun audit --audit-level=high

    - name: client lint
      run: bunx biome check

    - name: client unit tests
      run: bun run test

  # DOC: https://docs.github.com/en/actions/publishing-packages/publishing-docker-images
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    needs: [server-testing, client-testing, versioning]

    steps:
    - uses: actions/checkout@v4

    - run: echo "${{secrets.GITHUB_TOKEN}}" | docker login ghcr.io -u "${{github.actor}}" --password-stdin

    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        build-args: |
          VERSION=${{needs.versioning.outputs.version}}
        context: .
        push: true
        tags: ${{needs.versioning.outputs.imageName}}

  api-tests:
    runs-on: ubuntu-latest
    needs: [build-and-push, versioning]

    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-compose-action@v1
    - run: echo "${{secrets.GITHUB_TOKEN}}" | docker login ghcr.io -u "${{github.actor}}" --password-stdin
    - name: API tests
      run: |
        # echo "## ðŸŒ API tests using ${{needs.versioning.outputs.imageName}}" >> $GITHUB_STEP_SUMMARY

        export imageName=${{needs.versioning.outputs.imageName}}
        docker compose --profile api-tests up -d --quiet-pull
        echo "ðŸŸ¢ Docker launched"

        docker ps -a

        curl -sf -o /dev/null --retry 10 --retry-delay 10 --retry-max-time 100 --retry-connrefused http://localhost:8080/api/version
        echo "ðŸŸ¢ Backend responding"

        cd server
        go test ./api-tests -v

  auto-deploy:
    permissions:
      contents: write

    needs: [api-tests, build-and-push, versioning]
    if: ${{ (github.ref_type == 'tag') || (startsWith(github.event.head_commit.message, '[deploy]')) }}

    uses: ./.github/workflows/deploy.yml
    with:
      imageName: ${{needs.versioning.outputs.imageName}}
      version: ${{needs.versioning.outputs.version}}
